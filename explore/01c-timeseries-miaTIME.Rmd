---
title: "Time series (miaTime)"
date: "Compiled at `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'UTC')` UTC"
output: github_document
params:
  name: "01c-timeseries-miaTIME" # change if you rename file
---

```{r here, message=FALSE}
here::i_am(paste0(params$name, ".Rmd"), uuid = "87d828ae-2f1b-40a8-b559-3784df62c78d")
```


# Packages

```{r packages, warning=FALSE, message=FALSE}
library("conflicted")
library(data.table)
library(dplyr)
library(ggplot2)
library(viridis) # for color palettes 
library(stringr)

library(miaTime)
library(mia)

library(phyloseq)
library(microViz) # for ps_reorder()
library(biomeUtils) # for removeZeros()
library("xlsx")

```

```{r directories}
# create or *empty* the target directory, used to write this file's data: 
projthis::proj_create_dir_target(params$name, clean = TRUE)

# function to get path to target directory: path_target("sample.csv")
path_target <- projthis::proj_path_target(params$name)

# function to get path to previous data: path_source("00-import", "sample.csv")
path_source <- projthis::proj_path_source(params$name)
```


## Load dataset (SilvermanAGutData)

```{r}
# load the Silverman artificial gut data set from miaTIME

data(SilvermanAGutData)

```


## Make Phyloseq

```{r}
# make phyloseq object out of TSE object
ps_Silverman <- makePhyloseqFromTreeSE(SilvermanAGutData)

```


### Remove zero samples

There are some samples with only 0 entries in the otu table.
These samples are removed from the dataset.

```{r, message=F}
# print names of samples with zero counts over all otus (colSum == 0)
zero_samples <-
  otu_table(ps_Silverman)[,colSums(otu_table(ps_Silverman)) == 0] %>%
  sample_names()
zero_samples

# remove above samples from the dataset
ps_Silverman <- 
  subset_samples(ps_Silverman, !(SampleID %in% zero_samples))
```


### Rename NAs in tax_table to "unknown"

```{r, message=FALSE}
tax_table(ps_Silverman)[is.na(tax_table(ps_Silverman))] <- 
  "unknown"
```


### Add date to sample info in phyloseq

```{r}
# extract time info from sample names

# create columns for day/hour info
sample_names <- sample_names(ps_Silverman)
sample_cols <- 
  data.table(names = sample_names,
             day = tstrsplit(sample_names, "\\.")[[3]],
             hours = str_extract(sample_names, "[0-9][0-9]h")) %>% 
  # format days and hours as numeric
  .[, day := as.numeric(str_remove(day, "d"))] %>% 
  .[, hours := as.numeric(str_remove(hours, "h"))] %>% 
  # set time to decimal value in days
  .[, time := day + hours/24] %>% 
  .[is.na(hours), time := day]

```


```{r, message=FALSE}
# Create dataframe including Time (in days) info out of rownames
sam.new <- data.frame(Time = sample_cols$time)
# Mix up the sample names (just for demonstration purposes)
rownames(sam.new) <- sample_cols$names

# Turn into `sample_data` 
sam.new <- sample_data(sam.new)

ps_Silverman <- merge_phyloseq(ps_Silverman, sam.new)
# head(sample_data(ps_Silverman))
```


```{r, message=FALSE}
# remove samples of day 28 from analysis
ps_Silverman <-
  subset_samples(ps_Silverman, Time < 28)
```


### Duplicates

There are still some duplicated samples regarding time. These are listed below:

```{r, message=FALSE}
# duplicates in Time/Vessel/SampleType:
get_all_duplicates <- function(data_phylo){
  data <- sample_data(data_phylo) # %>% subset(data, Time < 28)
  data_TVS <-
    data[, c("Time", "Vessel", "SampleType")]
  res <-
    data[duplicated(data_TVS) |
           duplicated(data_TVS, fromLast = T)]
  setorder(res, Vessel, Time)
  return(res)
}

# vector with all duplicated SampleIDs
duplicated_samples_ID <-
  get_all_duplicates(ps_Silverman)$SampleID

# subset of data set only including duplicates
ps_Silverman_duplicates <-
  subset_samples(ps_Silverman, SampleID %in% duplicated_samples_ID) %>% 
  ps_reorder(duplicated_samples_ID)

# plot abundances of duplicates
# plot_bar(ps_Silverman_duplicates, fill = "Species") + 
#   theme(legend.position = "none",
#         axis.text.x = element_blank())
ggplot(psmelt(ps_Silverman_duplicates),
       aes(x = SampleID, y = Abundance, col = Genus)) +
  geom_point() + 
  theme(legend.position = "none")

# # show otu table of all duplicates (zero entries excluded)
# removeZeros(ps_Silverman_duplicates) %>% otu_table() %>% view()

write.xlsx(
  otu_table(removeZeros(ps_Silverman_duplicates)),
  paste0(path_target(), "/duplicated_samples.xlsx"),
  sheetName = "Sheet1",
  col.names = TRUE,
  row.names = TRUE,
  append = FALSE
)

# subset of data set not including duplicated samples
ps_Silverman_unique <-
  subset_samples(ps_Silverman, !(SampleID %in% duplicated_samples_ID))

```

#### Get mean for duplicates

```{r, message=FALSE}
# load this R script which slightly modifies the merge_sample function of phyloseq package
source("../R/merge-methods-modified.R")
```

Generate another phyloseq object ("ps_Silverman_noDuplicates") containing all samples of SilvermanAGutData (all counts for unique samples and for the duplicates the mean counts).

```{r, message=FALSE}
# add group for merging
# therefore only use first part of sampleID name which is the same for each duplicates
sample_data(ps_Silverman_duplicates)$SampleID_new <-
  sample_data(ps_Silverman_duplicates)$SampleID %>%
  gsub("Rep1.*", "Rep1", .) %>%
  gsub("Rep.1.*", "Rep.1", .) %>%
  paste0(".merged")

# define the function how to merge the sample data
# for numeric values: take mean
# for other values: unique and paste values (separated by ;)
merge_fun <- function(x, fun = mean){
  if(is.numeric(x)){
    fun(x)
  } else {
    paste(unique(x), collapse = ";")
    # if(uniqueN(x) > 1){
    #   return(NA)
    # } else{
    #   return(unique(x))
    # }
  }
}

# use modified version of merge_samples to merge all duplicates and set mean count in otu table
ps_Silverman_merged <-
  modmerge_samples(ps_Silverman_duplicates,
                group = "SampleID_new",
                fun = merge_fun)

# redefine SampleID and remove SampleID_new
sample_data(ps_Silverman_merged)$SampleID <- 
  sample_data(ps_Silverman_merged)$SampleID_new
sample_data(ps_Silverman_merged)$SampleID_new <- NULL

# merge mean values of duplicates to unique values of Silverman data set
ps_Silverman_noDuplicates <-
  merge_phyloseq(ps_Silverman_unique, ps_Silverman_merged)
```


```{r, message=FALSE}
# replace duplicates with mean entries in original data set
ps_Silverman <- 
  ps_Silverman_noDuplicates

# add time as.factor for plots
sample_data(ps_Silverman)$Time_factor <-
  ordered(sample_data(ps_Silverman)$Time)
```



### Subsets

Create subsets for each vessel and for daily/hourly samples.
 
```{r, message=FALSE}
# transform counts to relative abundance
ps_Silverman <-
  transform_sample_counts(ps_Silverman,
                          function(x) x / sum(x))

# # set resulting NAs to zero
# otu_table(ps_Silverman)[is.na(otu_table(ps_Silverman))] <- 0
# # --> not needed since "Remove zero samples" was done previously


# devide into daily and hourly samples

ps_Silverman_daily <- 
  # subset_samples(ps_Silverman, SampleType=="Daily")
  subset_samples(ps_Silverman, Time == as.integer(Time))

ps_Silverman_hourly <- 
  # subset_samples(ps_Silverman, SampleType=="Hourly")
  subset_samples(ps_Silverman, Time > 19 & Time < 25)


# devide by Vessels
for(vessel in 1:4){
  assign(paste0("ps_Silverman_V", vessel),
         subset_samples(ps_Silverman, 
                        Vessel == vessel))
  assign(paste0("ps_Silverman_daily_V", vessel),
         subset_samples(ps_Silverman_daily, 
                        Vessel == vessel))
  assign(paste0("ps_Silverman_hourly_V", vessel),
         subset_samples(ps_Silverman_hourly, 
                        Vessel == vessel))
}

```


### Mean subsets

```{r}
# Get a dataset, that contains mean over all vessels in one
ps_Silverman_mean <- copy(ps_Silverman)
sample_data(ps_Silverman_mean) <- 
  sample_data(ps_Silverman_mean)[, c("Time", "Time_factor")]
ps_Silverman_mean <-
  merge_samples(ps_Silverman_mean, group = "Time") %>% 
  transform_sample_counts(function(x) x / sum(x))

# devide into daily and hourly samples
ps_Silverman_mean_daily <- 
  subset_samples(ps_Silverman_mean, Time == as.integer(Time))
ps_Silverman_mean_hourly <- 
  subset_samples(ps_Silverman_mean, Time > 19 & Time < 25)
```


### Plots

```{r plot_dayhour}
# whole daily dataset
plot_bar(ps_Silverman_mean_daily, x = "Time", fill = "Family") +
  theme(legend.position = "none") +
  geom_bar(aes(color=Family, fill=Family), stat="identity", position="stack") +
  labs(title = "Silverman daily (by Family)",
       x = "Time [day]")

# whole hourly dataset
plot_bar(ps_Silverman_mean_hourly, x = "Time", fill = "Family") +
  theme(legend.position = "none") +
  geom_bar(aes(color=Family, fill=Family), stat="identity", position="stack") +
  labs(title = "Silverman hourly (by Family)",
       x = "Time [day]")

```



```{r plot_vessels}
# plots for each vessel
for (vessel in 1:4) {
  plt_tmp <-
    plot_bar(get(paste0("ps_Silverman_V", vessel)),
             x = "Time_factor", fill = "Genus",
             title = paste("Samples of Vessel", vessel, " (on Genus level)")) +
    theme(legend.position = "none") +
    geom_bar(aes(color = Genus, fill = Genus),
             stat = "identity",
             position = "stack")
  print(plt_tmp)
}

```


## Save phyloseq objects as csv file

```{r}

saveRDS(ps_Silverman,
        path_target("ps_Silverman_rel_counts.rds"))

# data vessel wise
for (vessel in c(1:4)) {
  saveRDS(get(paste0("ps_Silverman_V", vessel)),
          path_target(paste0("ps_Silverman_V", vessel, "_rel_counts.rds")))
}

# daily/hourly data (mean over all Vessels)
saveRDS(ps_Silverman_mean_daily,
        path_target("ps_Silverman_Vall_daily_rel_counts.rds"))
saveRDS(ps_Silverman_mean_hourly,
        path_target("ps_Silverman_Vall_hourly_rel_counts.rds"))


```


## Files written

These files have been written to the target directory, ```r paste0("data/", params$name)```:

```{r list-files-target}
projthis::proj_dir_info(path_target())
```
