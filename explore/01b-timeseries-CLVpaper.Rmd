---
title: "Time series (Compositional Lotka Volterra)"
date: "Compiled at `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'UTC')` UTC"
output: github_document
params:
  name: "01b-timeseries-CLVpaper" # change if you rename file
---

```{r here, message=FALSE}
here::i_am(paste0(params$name, ".Rmd"), uuid = "fbad9ade-134a-4a83-a801-9900003f3395")
```

The purpose of this document is to have a look at the time series data used in the Compositional Lotka Volterra paper.

```{r packages, message=FALSE}
library("conflicted")
library(tidyverse)
library(data.table)
```


```{r directories}
# create or *empty* the target directory, used to write this file's data: 
projthis::proj_create_dir_target(params$name, clean = TRUE)

# function to get path to target directory: path_target("sample.csv")
path_target <- projthis::proj_path_target(params$name)

# function to get path to previous data: path_source("00-import", "sample.csv")
path_source <- projthis::proj_path_source(params$name)
```

## Main

### Bucci

#### Read data

```{r}
#### read the file
dt_bucci_raw <- 
  fread("data/clv/bucci/data_cdiff/counts.txt", header = T)

knitr::kable(head(dt_bucci_raw))

# change format of count data
dt_bucci_long <-
  melt(dt_bucci_raw,
       id.vars = "Species", value.name = "Count", variable.name = "sampleID") %>% 
  .[, sampleID := as.numeric(as.character(sampleID))]

# read metadata file
dt_bucci_meta <-
  fread("data/clv/bucci/data_cdiff/metadata.txt", header = T)

# merge metadata to count data
dt_bucci_long <-
  merge(dt_bucci_long, dt_bucci_meta, by = "sampleID")

# show first rows of table
knitr::kable(head(dt_bucci_long))

```


Info about time points: When was the data collected?

Fecal pellets were collected at days 0.75, 1, 2, 3, 4, 6, 8, 10, 14, 17, 21, 24, and 28 of the initial colonization 
and at days 0.75, 1, 2, 3, 4, 6, 8, 10, 14, 17, 21, 24, and 28 post-infection with C. difficile.


#### Plot data

```{r}
ggplot(dt_bucci_long[subjectID == 1], aes(measurementid, Count)) +
    geom_bar(aes(fill = Species), stat = "identity") +
    theme(legend.position = "none") +
    labs(x = "Time",
         title = paste("Subject", 1))

for(i in 1:5){
  pl <- ggplot(dt_bucci_long[subjectID == i], aes(as.factor(measurementid), Count)) +
    geom_bar(aes(fill = Species), stat = "identity", position = "fill") +
    theme(legend.position = "none") +
    labs(x = "Time",
         title = paste("Subject", i))
  
  print(pl)
}

```

### Stein

#### Read data

```{r}
#### read the file

# # preparation of the data
# dt_stein_raw <-
#   fread("data/clv/stein/raw_data.csv") %>%
#   t() %>%
#   .[, lapply(.SD, as.numeric)]
# 
# write.table(dt_stein_raw,
#           "data/clv/stein/raw_data_transposed.csv",
#           row.names = FALSE)

dt_stein_raw <- 
  fread("data/clv/stein/raw_data_transposed.csv")

dt_stein_long <-
  melt(dt_stein_raw,
       id.vars = c("Population", "Replicate", "ID", "time (in d)", "Clindamycin signal"), 
       variable.name = "Genus")

```


#### List of Genus

```{r}
dt_stein_long$Genus %>% unique()
```


#### Plot data

```{r}

for (i in 1:9) {
  plot_tmp <-
    ggplot(dt_stein_long[ID == i]) +
      # geom_line(aes(`time (in d)`, value, col = Genus)) +
      geom_bar(aes(`time (in d)`, value, fill = Genus), 
               stat = "identity", position = "fill") +
      theme(legend.position = "bottom") +
      # ylim(0, 6.2) +
      xlim(0,25) +
    labs(title = paste("ID =", i))
  
  print(plot_tmp)
}

```



## Files written

These files have been written to the target directory, ```r paste0("data/", params$name)```:

```{r list-files-target}
projthis::proj_dir_info(path_target())
```
