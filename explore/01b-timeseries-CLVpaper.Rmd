---
title: "Time series (Compositional Lotka Volterra)"
date: "Compiled at `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'UTC')` UTC"
output: github_document
params:
  name: "01b-timeseries-CLVpaper" # change if you rename file
---

```{r here, message=FALSE}
here::i_am(paste0(params$name, ".Rmd"), uuid = "fbad9ade-134a-4a83-a801-9900003f3395")
```

The purpose of this document is to have a look at the time series data used in the Compositional Lotka Volterra paper.

## Packages

```{r packages, message=FALSE}
library("conflicted")
library(tidyverse)
library(data.table)
library(viridis) # for color palettes
```


```{r directories}
# create or *empty* the target directory, used to write this file's data: 
projthis::proj_create_dir_target(params$name, clean = TRUE)

# function to get path to target directory: path_target("sample.csv")
path_target <- projthis::proj_path_target(params$name)

# function to get path to previous data: path_source("00-import", "sample.csv")
path_source <- projthis::proj_path_source(params$name)
```

# Main

## Bucci

### Read data

```{r}
#### read the file
dt_bucci_raw <- 
  fread("data/clv/bucci/data_cdiff/counts.txt", header = T)

knitr::kable(head(dt_bucci_raw))

# change format of count data
dt_bucci_long <-
  melt(dt_bucci_raw,
       id.vars = "Species", value.name = "Count", variable.name = "sampleID") %>% 
  .[, sampleID := as.numeric(as.character(sampleID))]

# read metadata file
dt_bucci_meta <-
  fread("data/clv/bucci/data_cdiff/metadata.txt", header = T)

# merge metadata to count data
dt_bucci_long <-
  merge(dt_bucci_long, dt_bucci_meta, by = "sampleID")

# show first rows of table
knitr::kable(head(dt_bucci_long))

```


Info about time points: When was the data collected?

Fecal pellets were collected at days 0.75, 1, 2, 3, 4, 6, 8, 10, 14, 17, 21, 24, and 28 of the initial colonization 
and at days 0.75, 1, 2, 3, 4, 6, 8, 10, 14, 17, 21, 24, and 28 post-infection with C. difficile.



### Plot data

#### by Species

```{r}
# plot time series in correct time intervals
ggplot(dt_bucci_long[subjectID == 1], aes(measurementid, Count)) +
    geom_bar(aes(fill = Species), stat = "identity") +
    theme(legend.position = "none") +
    labs(x = "Time",
         title = paste("Subject", 1)) +
    scale_fill_viridis(discrete = TRUE, option = "turbo")

# plot time series with no distance between time intervals
for(i in 1:5){
  pl <- ggplot(dt_bucci_long[subjectID == i], aes(as.factor(measurementid), Count)) +
    geom_bar(aes(fill = Species), stat = "identity", position = "fill") +
    theme(legend.position = "right") +
    labs(x = "Time",
         title = paste("Subject", i)) +
    scale_fill_viridis(discrete = TRUE, option = "turbo")
  
  print(pl)
}

# plot mean count over all mice
ggplot(dt_bucci_long, 
               aes(as.factor(measurementid), Count)) +
    geom_bar(aes(fill = Species), stat = "identity", position = "fill") +
    theme(legend.position = "right") +
    labs(x = "Time",
         title = paste("All Subjects")) +
    scale_fill_viridis(discrete = TRUE, option = "turbo")

```
```{r}
# * add category "other" for Species with small count
th_species <- 0.05

dt_species_other <-
  dt_bucci_long[, rel_count_species := Count/sum(Count),
              by = c("subjectID", "measurementid", "sampleID")] %>% 
  .[, .(max_count = max(rel_count_species)),
             by = c("Species")] %>% 
      .[max_count < th_species, .(Species)]

dt_bucci_long[, Species_grouped := Species] %>% 
  .[Species %in% dt_species_other$Species, Species_grouped := "other"]


# plot count over all mice for grouped species
ggplot(dt_bucci_long, 
               aes(as.factor(measurementid), Count)) +
    geom_bar(aes(fill = Species_grouped), stat = "identity", position = "fill") +
    theme(legend.position = "right") +
    labs(x = "Time",
         title = paste("All Subjects")) +
    scale_fill_viridis(discrete = TRUE, option = "turbo")

```


#### by Genus


```{r}
# add Genus column
dt_bucci_long[, Genus := tstrsplit(Species, "-")[1]]


# plot time series by genus

ggplot(dt_bucci_long[subjectID == 1], aes(measurementid, Count)) +
    geom_bar(aes(fill = Genus), stat = "identity") +
    theme(legend.position = "right") +
    labs(x = "Time",
         title = paste("Subject", 1)) +
    scale_fill_viridis(discrete = TRUE, option = "turbo")

for(i in 1:5){
  pl <- ggplot(dt_bucci_long[subjectID == i], 
               aes(as.factor(measurementid), Count)) +
    geom_bar(aes(fill = Genus), stat = "identity", position = "fill") +
    theme(legend.position = "right") +
    labs(x = "Time",
         title = paste("Subject", i)) +
    scale_fill_viridis(discrete = TRUE, option = "turbo")
  
  print(pl)
}

ggplot(dt_bucci_long, 
               aes(as.factor(measurementid), Count)) +
    geom_bar(aes(fill = Genus), stat = "identity", position = "fill") +
    theme(legend.position = "right") +
    labs(x = "Time",
         title = paste("All Subjects")) +
    scale_fill_viridis(discrete = TRUE, option = "turbo")

```


```{r}
# add category "other" for Genus with small count
th_genus <- 0.05

dt_genus_other <-
  dt_bucci_long[, rel_count_genus := Count/sum(Count),
              by = c("subjectID", "measurementid", "sampleID")] %>% 
  .[, .(max_count = max(rel_count_genus)),
             by = c("Genus")] %>% 
      .[max_count < th_genus, .(Genus)]

dt_bucci_long[, Genus_grouped := Genus] %>% 
  .[Genus %in% dt_genus_other$Genus, Genus_grouped := "other"]


# plot count over all mice for grouped genus
ggplot(dt_bucci_long, 
               aes(as.factor(measurementid), Count)) +
    geom_bar(aes(fill = Genus_grouped), stat = "identity", position = "fill") +
    theme(legend.position = "right") +
    labs(x = "Time",
         title = paste("All Subjects")) +
    scale_fill_viridis(discrete = TRUE, option = "turbo")

```

<!-- ```{r} -->
<!-- # add mean count and sum count of all mice -->
<!-- dt_bucci_long[, Count_mean := mean(Count), -->
<!--               by = c("measurementid", "Species")] %>%  -->
<!--   .[, Count_sum := sum(Count), -->
<!--               by = c("measurementid", "Species")] -->
<!-- ``` -->



## Files written

These files have been written to the target directory, ```r paste0("data/", params$name)```:

```{r list-files-target}
projthis::proj_dir_info(path_target())
```
