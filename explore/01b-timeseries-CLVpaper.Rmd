---
title: "Time series (Bucci Dataset from cLV paper)"
date: "Compiled at `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'UTC')` UTC"
output: github_document
params:
  name: "01b-timeseries-CLVpaper" # change if you rename file
---

```{r here, message=FALSE}
here::i_am(paste0(params$name, ".Rmd"), uuid = "fbad9ade-134a-4a83-a801-9900003f3395")
```

In this document the pre-processing of the "Bucci" dataset from the Compositional Lotka Volterra paper is done.

# Packages

```{r packages, message=FALSE}
library("conflicted")
library(tidyverse)
library(data.table)
library(viridis) # for color palettes
library(phyloseq)
library(microViz)

library(ggfortify) # to autoplot time series
```


```{r directories}
# create or *empty* the target directory, used to write this file's data: 
projthis::proj_create_dir_target(params$name, clean = TRUE)

# function to get path to target directory: path_target("sample.csv")
path_target <- projthis::proj_path_target(params$name)

# function to get path to previous data: path_source("00-import", "sample.csv")
path_source <- projthis::proj_path_source(params$name)
```


# Bucci dataset

## Read data

```{r}
folderpath <- 
  "C:/Users/Maria/Documents/Masterstudium/Masterarbeit/Literatur/Code/clv/data/bucci/data_cdiff/"
  
#### read the file
dt_bucci_raw <- 
  fread("data/clv/bucci/data_cdiff/counts.txt", header = T)

knitr::kable(head(dt_bucci_raw))

# read metadata file
dt_bucci_meta <-
  fread("data/clv/bucci/data_cdiff/metadata.txt", header = T)

head(dt_bucci_meta)

# read taxonomic information
dt_tax_bucci <-
  fread(paste0(folderpath, "taxonomy_table.csv"), header = T)

```

## Info 

... on the time points: When was the data collected?

Fecal pellets were collected at days 0.75, 1, 2, 3, 4, 6, 8, 10, 14, 17, 21, 24, and 28 of the initial colonization 
and at days 0.75, 1, 2, 3, 4, 6, 8, 10, 14, 17, 21, 24, and 28 post-infection with C. difficile.

--> measurementid


## Phyloseq

### Prepare otu table

```{r}
mat_otu_bucci <-
  dt_bucci_raw %>%
    tibble::column_to_rownames("Species")
colnames(mat_otu_bucci) <-
  sprintf("ID-%03d", as.numeric(colnames(mat_otu_bucci)))

OTU_bucci = otu_table(mat_otu_bucci, taxa_are_rows = TRUE)

```


### Prepare sample table (metadata)

```{r}
mat_samples_bucci <-
  copy(dt_bucci_meta) %>% 
  .[, sampleID := sprintf("ID-%03d", sampleID)] %>%
  tibble::column_to_rownames("sampleID") 

samples_bucci = sample_data(mat_samples_bucci)

```


### Generate taxonomic table

```{r}
mat_tax_bucci <-
  dt_tax_bucci %>% 
  tibble::column_to_rownames("Names") 

TAX_bucci = tax_table(as.matrix(mat_tax_bucci))

```


### Create phyloseq object

```{r}
ps_bucci_all <- phyloseq(OTU_bucci, TAX_bucci, samples_bucci)
```


### Devide dataset by subjects

```{r}
# change count data to relative counts
# filter for most abundant species

ps_bucci_rel <- 
  ps_bucci_all %>% 
  transform_sample_counts(function(x) x / sum(x)) %>% 
  filter_taxa(function(x) mean(x) > 1e-5, TRUE)


# get a subset for each subject 

ps_bucci_1 <-
  subset_samples(ps_bucci_rel, subjectID == 1)

ps_bucci_2 <-
  subset_samples(ps_bucci_rel, subjectID == 2)

ps_bucci_3 <-
  subset_samples(ps_bucci_rel, subjectID == 3)

ps_bucci_4 <-
  subset_samples(ps_bucci_rel, subjectID == 4)

ps_bucci_5 <-
  subset_samples(ps_bucci_rel, subjectID == 5)

```

### plot data

```{r}
# plot for all subjects

sample_data(ps_bucci_rel)$time <- 
  ordered(sample_data(ps_bucci_rel)$measurementid)

plot_bar(ps_bucci_rel,
         x = "time",
         fill = "Species",
         title = "All Subjects") +
  geom_bar(aes(color=Species, fill=Species), stat="identity", position="stack")

```


```{r}
# plots for all subjects separately
for (id in 1:5) {
  plt_tmp <-
    plot_bar(get(paste0("ps_bucci_", id)),
             # x = "measurementid", 
             fill = "Species",
             title = paste("Subject", id))
  
  print(plt_tmp)
}
```

### Save phyloseq of all subjects to test in deepymod

```{r}
for(id in 1:5){
  # get the tmp phyloseq object
  ps_obj <- get(paste0("ps_bucci_", id))
  
  # combine count data with time information
  ts_obj <-
    cbind(sample_data(ps_obj)[, "measurementid"],
          t(otu_table(ps_obj)))
  
  # save time series as csv file
  write.csv(
    ts_obj,
    paste0(path_target(), "/ts_bucci_subject_", id, "_rel_count.csv"),
    row.names = F
  )
  
  # plot time series
  print(autoplot(ts(ts_obj[,2:17]), facets = F))
}

```




## Files written

These files have been written to the target directory, ```r paste0("data/", params$name)```:

```{r list-files-target}
projthis::proj_dir_info(path_target())
```
